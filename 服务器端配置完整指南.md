# 🔒 服务器端配置完整指南

## 🎯 为什么需要服务器端配置？

### 问题：什么是服务器端 vs 客户端？

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  客户端 (浏览器)          服务器端 (Vercel)            │
│  ════════════════          ═══════════════════          │
│                                                         │
│  用户的浏览器              Vercel 的服务器             │
│  • 任何人都能看到          • 只有服务器能访问          │
│  • F12 控制台可见          • 用户完全看不到            │
│  • JavaScript 代码         • Node.js 后端代码          │
│  • 不安全                  • 安全                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 为什么 API Key 必须在服务器端？

#### ❌ 错误方式：客户端存储 API Key

```typescript
// ❌ 危险！前端代码
const API_KEY = "08108945-f5b2-4aa4-8453-58e16774c9ba";

fetch(`https://mainnet.helius-rpc.com/?api-key=${API_KEY}`)
```

**问题**:
- ⚠️ 任何人打开 F12 都能看到 API Key
- ⚠️ 别人可以盗用你的 API Key
- ⚠️ 可能产生巨额费用
- ⚠️ 账号被封禁

#### ✅ 正确方式：服务器端存储 API Key

```typescript
// ✅ 安全！后端代码 (app/api/scan/route.ts)
// 服务器端环境变量
const API_KEY = process.env.HELIUS_API_KEY;

// 用户看不到这个 Key
fetch(`https://mainnet.helius-rpc.com/?api-key=${API_KEY}`)
```

**优势**:
- ✅ 用户完全看不到 API Key
- ✅ 代码在服务器执行
- ✅ 安全保护
- ✅ 可控访问

---

## 📊 Next.js 的两种环境变量

### 1. 客户端环境变量 (NEXT_PUBLIC_*)

```bash
# 前端可见，用户能看到
NEXT_PUBLIC_VERSION_MAJOR=1
NEXT_PUBLIC_VERSION_MINOR=0
NEXT_PUBLIC_VERSION_COMMIT_TIME=10-28 21:30
```

**特点**:
- 必须有 `NEXT_PUBLIC_` 前缀
- 构建时嵌入到 JavaScript 代码中
- 浏览器可以访问
- 用于非敏感信息（版本号、公开配置）

**用途**:
- 版本号显示
- 公开的配置项
- 主题颜色
- 公开的 API 端点

### 2. 服务器端环境变量 (无前缀)

```bash
# 服务器专用，用户看不到
HELIUS_API_KEY=08108945-f5b2-4aa4-8453-58e16774c9ba
SOLANA_CLUSTER=mainnet
DATABASE_URL=postgresql://...
```

**特点**:
- **没有** `NEXT_PUBLIC_` 前缀
- 只在服务器端可用
- 浏览器完全访问不到
- 用于敏感信息（API Key、密码、密钥）

**用途**:
- API 密钥
- 数据库连接字符串
- 私密配置
- 加密密钥

---

## 🔧 如何配置服务器端环境变量

### 方法 1: Vercel Dashboard (推荐)

#### 步骤 1: 登录 Vercel

```
访问: https://vercel.com/dashboard
登录您的账号
```

#### 步骤 2: 找到项目

```
在 Dashboard 中找到:
solana-liquidation-dashboard
或
liquidation-bot

点击进入项目
```

#### 步骤 3: 进入环境变量设置

```
Project → Settings → Environment Variables

或直接访问:
https://vercel.com/[你的用户名]/[项目名]/settings/environment-variables
```

#### 步骤 4: 添加环境变量

##### A. 客户端变量 (前端可见)

点击 **"Add New"**，逐个添加：

| 变量名 | 值 | 环境 |
|--------|-----|------|
| `NEXT_PUBLIC_VERSION_MAJOR` | `1` | ☑ Production ☑ Preview ☑ Development |
| `NEXT_PUBLIC_VERSION_MINOR` | `0` | ☑ Production ☑ Preview ☑ Development |
| `NEXT_PUBLIC_VERSION_PATCH` | `0` | ☑ Production ☑ Preview ☑ Development |
| `NEXT_PUBLIC_VERSION_PREFIX` | `v` | ☑ Production ☑ Preview ☑ Development |
| `NEXT_PUBLIC_VERSION_COMMIT_TIME` | `10-28 21:30` | ☑ Production ☑ Preview ☑ Development |

**⚠️ 注意**: 必须有 `NEXT_PUBLIC_` 前缀

##### B. 服务器端变量 (私密，用户看不到)

继续添加：

| 变量名 | 值 | 环境 |
|--------|-----|------|
| `HELIUS_API_KEY` | `08108945-f5b2-4aa4-8453-58e16774c9ba` | ☑ Production ☑ Preview ☑ Development |
| `SOLANA_CLUSTER` | `mainnet` | ☑ Production ☑ Preview ☑ Development |
| `SOLANA_MAINNET_RPC` | `https://api.mainnet-beta.solana.com` | ☑ Production ☑ Preview ☑ Development |
| `SOLANA_DEVNET_RPC` | `https://api.devnet.solana.com` | ☑ Production ☑ Preview ☑ Development |
| `SOLANA_TESTNET_RPC` | `https://api.testnet.solana.com` | ☑ Production ☑ Preview ☑ Development |

**⚠️ 注意**: **不要**有 `NEXT_PUBLIC_` 前缀

##### 配置示例截图说明

```
┌─────────────────────────────────────────────────┐
│ Add Environment Variable                        │
├─────────────────────────────────────────────────┤
│                                                 │
│ Name:                                           │
│ ┌─────────────────────────────────────────────┐ │
│ │ HELIUS_API_KEY                              │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ Value:                                          │
│ ┌─────────────────────────────────────────────┐ │
│ │ 08108945-f5b2-4aa4-8453-58e16774c9ba        │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ Environments:                                   │
│ ☑ Production                                    │
│ ☑ Preview                                       │
│ ☑ Development                                   │
│                                                 │
│              [Cancel]  [Save]                   │
└─────────────────────────────────────────────────┘
```

#### 步骤 5: 触发重新部署

**重要**: 添加环境变量后必须重新部署！

##### 方式 1: Dashboard 重新部署

```
1. 返回项目主页
2. 点击 "Deployments" 标签
3. 找到最新的部署
4. 点击右侧的 "..." 菜单
5. 选择 "Redeploy"
6. 确认
```

##### 方式 2: Git 推送触发

```bash
cd /home/lc/luckee_dao/solana-liquidation-dashboard

git commit --allow-empty -m "chore: 触发部署以应用环境变量"
git push origin master
```

##### 方式 3: Vercel CLI

```bash
cd /home/lc/luckee_dao/solana-liquidation-dashboard
vercel --prod --yes
```

#### 步骤 6: 等待部署完成

```
预计时间: 2-3 分钟

查看部署状态:
Dashboard → Deployments → 最新部署

等待状态变为:
✅ Ready (绿色对勾)
```

#### 步骤 7: 验证配置

##### 测试 1: 访问调试页面

```
https://sbot.cdao.online/debug
```

**预期结果**:

```json
{
  "VERSION_MAJOR": "1",
  "VERSION_MINOR": "0",
  "VERSION_PATCH": "0",
  "VERSION_PREFIX": "v",
  "VERSION_COMMIT_TIME": "10-28 21:30"
}

组合版本号: v1.0.0 (10-28 21:30)
```

如果显示 `undefined` 或 `?`，说明配置未生效。

##### 测试 2: 访问主页

```
https://sbot.cdao.online/
```

**预期结果**:
```
标题显示: 🚀 Solana 清算机器人 [ v1.0.0 (10-28 21:30) ]
```

##### 测试 3: 点击扫描

点击 "开始扫描" 按钮

**预期结果**:
```
✅ RPC 连接成功
📡 RPC 提供商: Helius Mainnet (或 Solana 公开节点)
🔢 当前 Slot: [大数字]

📊 扫描结果
总账户: X 个
```

---

### 方法 2: Vercel CLI (适合自动化)

#### 安装 Vercel CLI

```bash
npm i -g vercel
```

#### 登录

```bash
vercel login
```

#### 设置环境变量

```bash
cd /home/lc/luckee_dao/solana-liquidation-dashboard

# 客户端变量 (NEXT_PUBLIC_)
vercel env add NEXT_PUBLIC_VERSION_MAJOR production <<< "1"
vercel env add NEXT_PUBLIC_VERSION_MINOR production <<< "0"
vercel env add NEXT_PUBLIC_VERSION_PATCH production <<< "0"
vercel env add NEXT_PUBLIC_VERSION_PREFIX production <<< "v"
vercel env add NEXT_PUBLIC_VERSION_COMMIT_TIME production <<< "10-28 21:30"

# 服务器端变量 (无前缀)
vercel env add HELIUS_API_KEY production <<< "08108945-f5b2-4aa4-8453-58e16774c9ba"
vercel env add SOLANA_CLUSTER production <<< "mainnet"
vercel env add SOLANA_MAINNET_RPC production <<< "https://api.mainnet-beta.solana.com"
vercel env add SOLANA_DEVNET_RPC production <<< "https://api.devnet.solana.com"
vercel env add SOLANA_TESTNET_RPC production <<< "https://api.testnet.solana.com"
```

#### 部署

```bash
vercel --prod --yes
```

---

### 方法 3: 使用自动化脚本

我们已经创建了脚本来简化这个过程：

```bash
cd /home/lc/luckee_dao/solana-liquidation-dashboard

# 确保已登录 Vercel
vercel login

# 运行配置脚本
./scripts/setup-vercel-env.sh
```

脚本会自动：
- 读取 `../solana-liquidation-bot/env/.info`
- 提取版本信息和配置
- 设置所有 Vercel 环境变量
- 提示您重新部署

---

## 🔍 如何验证配置是否正确

### 检查清单

#### 1. Vercel Dashboard 检查

```
Settings → Environment Variables

确认存在以下变量:

客户端 (NEXT_PUBLIC_*):
✓ NEXT_PUBLIC_VERSION_MAJOR = 1
✓ NEXT_PUBLIC_VERSION_MINOR = 0
✓ NEXT_PUBLIC_VERSION_PATCH = 0
✓ NEXT_PUBLIC_VERSION_PREFIX = v
✓ NEXT_PUBLIC_VERSION_COMMIT_TIME = 10-28 21:30

服务器端 (无前缀):
✓ HELIUS_API_KEY = 08108945-...
✓ SOLANA_CLUSTER = mainnet
✓ SOLANA_MAINNET_RPC = https://api...
✓ SOLANA_DEVNET_RPC = https://api...
✓ SOLANA_TESTNET_RPC = https://api...

每个变量应该都有:
☑ Production
☑ Preview
☑ Development
```

#### 2. 部署状态检查

```
Deployments 标签

最新部署:
✓ Status: Ready (绿色)
✓ Build Time: ~2 分钟
✓ No errors in logs
```

#### 3. 网站功能检查

```
测试清单:
✓ https://sbot.cdao.online/ - 主页可访问
✓ 标题显示版本号: v1.0.0 (10-28 21:30)
✓ 状态栏显示: 集群、RPC、安全模式
✓ 点击"开始扫描"有响应
✓ 显示 RPC 连接状态
```

#### 4. 浏览器检查

打开 F12 控制台，查看：

```javascript
// 客户端变量应该可见
console.log(process.env.NEXT_PUBLIC_VERSION_MAJOR); // "1"

// 服务器端变量应该 undefined (安全！)
console.log(process.env.HELIUS_API_KEY); // undefined ✅
```

---

## 📋 完整配置清单

### 需要配置的 10 个环境变量

#### 前端可见（5 个）- 必须有 NEXT_PUBLIC_ 前缀

```bash
NEXT_PUBLIC_VERSION_MAJOR=1
NEXT_PUBLIC_VERSION_MINOR=0
NEXT_PUBLIC_VERSION_PATCH=0
NEXT_PUBLIC_VERSION_PREFIX=v
NEXT_PUBLIC_VERSION_COMMIT_TIME=10-28 21:30
```

#### 服务器端专用（5 个）- 不能有 NEXT_PUBLIC_ 前缀

```bash
HELIUS_API_KEY=08108945-f5b2-4aa4-8453-58e16774c9ba
SOLANA_CLUSTER=mainnet
SOLANA_MAINNET_RPC=https://api.mainnet-beta.solana.com
SOLANA_DEVNET_RPC=https://api.devnet.solana.com
SOLANA_TESTNET_RPC=https://api.testnet.solana.com
```

---

## ⚠️ 常见错误和解决方案

### 错误 1: 版本号显示为 v?.?.?

**原因**: 客户端环境变量未配置或前缀错误

**解决**:
```
1. 确认变量名有 NEXT_PUBLIC_ 前缀
2. 确认变量已添加到 Production 环境
3. 重新部署
4. 清除浏览器缓存 (Ctrl+Shift+R)
```

### 错误 2: 扫描无响应或报错

**原因**: 服务器端环境变量未配置

**解决**:
```
1. 确认 HELIUS_API_KEY 已添加
2. 确认没有 NEXT_PUBLIC_ 前缀
3. 检查 API Key 值是否正确
4. 重新部署
```

### 错误 3: API Key 在浏览器中可见

**原因**: 使用了 NEXT_PUBLIC_ 前缀

**解决**:
```
1. 删除 NEXT_PUBLIC_HELIUS_API_KEY
2. 添加 HELIUS_API_KEY (无前缀)
3. 重新部署
```

### 错误 4: 添加变量后还是不生效

**原因**: 没有重新部署

**解决**:
```
添加环境变量后必须重新部署！
环境变量在构建时读取，不是运行时。
```

---

## 🔐 安全最佳实践

### 1. 绝对不要

- ❌ 不要在前端代码中硬编码 API Key
- ❌ 不要给敏感信息加 NEXT_PUBLIC_ 前缀
- ❌ 不要提交 .env.local 到 Git
- ❌ 不要在公开场合分享 API Key

### 2. 务必要

- ✅ 使用服务器端环境变量存储 API Key
- ✅ 通过 API Routes 代理敏感请求
- ✅ 在 .gitignore 中忽略 .env.local
- ✅ 定期轮换 API Key

### 3. 项目结构

```
前端 (app/page.tsx)
  ↓ 调用
API Route (app/api/scan/route.ts)
  ↓ 使用服务器端环境变量
  ↓ API Key 不暴露给用户
Solana RPC (Helius)
```

---

## 🎯 快速开始

### 5 分钟完成配置

```bash
1. 访问 https://vercel.com/dashboard
   ⏱️ 1 分钟

2. Settings → Environment Variables
   添加 10 个变量
   ⏱️ 3 分钟

3. Deployments → Redeploy
   等待部署完成
   ⏱️ 2-3 分钟

4. 访问 https://sbot.cdao.online/
   验证功能
   ⏱️ 1 分钟

总计: ~7-8 分钟
```

---

## 📞 需要帮助？

如果配置后仍有问题：

1. **检查 Vercel Logs**
   ```
   Dashboard → Deployments → [最新部署] → Building
   查看是否有错误信息
   ```

2. **检查浏览器 Console**
   ```
   F12 → Console
   查看是否有 JavaScript 错误
   ```

3. **访问调试页面**
   ```
   https://sbot.cdao.online/debug
   查看环境变量是否正确加载
   ```

4. **查看 API 响应**
   ```
   F12 → Network → api/scan
   查看 API 调用是否成功
   ```

---

## ✅ 总结

### 为什么需要服务器端配置？

1. **安全性**: 保护 API Key 不被泄露
2. **隔离性**: 敏感信息只在服务器可用
3. **可控性**: 通过 API Routes 代理请求

### 如何配置？

1. **Vercel Dashboard**: 手动添加环境变量
2. **分类管理**:
   - 客户端: `NEXT_PUBLIC_*` 前缀
   - 服务器端: 无前缀
3. **重新部署**: 配置后必须部署

### 怎么验证？

1. 访问 `/debug` 页面
2. 检查标题版本号
3. 测试扫描功能
4. F12 确认 API Key 不可见

---

**立即开始**: 访问 https://vercel.com/dashboard 配置环境变量！

